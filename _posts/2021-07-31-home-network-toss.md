---
layout: post
title: "家庭网络折腾记"
description: "入住 3 年半，随着诉求的逐步升级，整个家庭网络也经历过多次迭代，不过由于装修时的埋线限制，很多想法不好实现，只能在当前的场景下寻求最优解，如果再有一次从毛坯重来的机会，肯定可以做的更好，就把自己这些折腾的过程记录一下"
category: life
tags: [network, toss, life]
---

## 0x00 缘起

写这篇文章主要还是想回顾下入住 3 年半，随着诉求的逐步升级，整个家庭网络也经历过多次迭代，不过由于装修时的埋线限制，很多想法不好实现，只能在当前的场景下寻求最优解，如果再有一次从毛坯重来的机会，肯定可以做的更好，就把自己这些折腾的过程记录一下。

## 0x01 户型

先介绍下背景，便于理解后续的展开，户型南北通透，大致方位布局如下：

![户型布局](https://cdn.jsdelivr.net/gh/jervyshi/jervyshi.github.io/assets/images/1627723195153-2ecd0186-276b-4bd8-82a5-b7c78a36b196.png)

弱电箱在书房，客厅拉了两根网线，主卧、次卧、书房各一根。

## 0x02 网络拓扑 V1


刚入住的时候，拉了电信宽带，弱电箱光猫直接两根网线接至客厅，一个给无线路由，一个给 IPTV，两个设备都居中放在客厅电视柜处，简单粗暴。

![家庭网络 V1.0.png](https://cdn.jsdelivr.net/gh/jervyshi/jervyshi.github.io/assets/images/1627713707033-d1ae1b0d-4bf3-4bdd-bf17-cae2d8a3eb03.png)

这个阶段大部分设备都围绕客厅路由器为主，包括 Xbox One S，Nintendo Switch、Synology NAS 都围绕在路由器周围，活动范围主要也是主卧和客厅，所以一切都还不错。各种智能吸顶灯、净水器、空气净化器等均以 2.4G 无线与主路由交互，弱电箱交换机都没有放，因为没有用其他网线的诉求。

主路由 ASUS AC88U 刷了 [Koolshare 改版的梅林固件](https://firmware.koolshare.cn/)，具备了基本的科学上网能力，借助 DDNS 能力也具备了在线管理路由器的能力，不过也没啥设备好管的。

## 0x03 网络拓扑 V2


随着时间的推移，有了宝宝，家里老人来带孩子，次卧就逐步启用了，这个时候主路由的信号瓶颈逐步凸显，次卧和次卫信号质量不佳，老人夜里想看看视频什么的体验就比较差，加上小区里竟然遇到过到家门口玄关偷鞋的贼一栋楼扫下来提走了几兜子的鞋，门口强电处放个摄像头就成了刚需，苦于没线可拉只能采用无线方案，但毕竟处于室外，摄像头很难稳定连接到主路由。

为了解决这个问题，闲鱼收了一个 AC68U，组了个 Mesh 网络，扩大了同 SSID 的无线覆盖面，AC68U 直接埋在了弱电箱里，此时拓扑变为：

![家庭网络 V2.0.png](https://cdn.jsdelivr.net/gh/jervyshi/jervyshi.github.io/assets/images/1627715989319-ef89f804-a911-46f2-91ea-150d7095a7b5.png)

主路由换为 AC68U 之后，科学上网的效果就不是太好了，本身性能就不高再加上大量加解密计算，对于我已经升级到千兆的宽带来说，还是有点扛不起大旗。工作搞 Service Mesh 的同时，在家也搞个 Mesh 网络，我跟 Mesh 还挺有缘 😀。

## 0x04 网络拓扑 V3

为了增加可玩性，在 V2 的基础上把主路由换成了软路由 R2S，当时 R2S 的价格还在合理区间，目前性价比已不高。固件是 404 大佬改过的 [OpenWRT](https://github.com/QiuSimons/R2S-R4S-X86-OpenWrt)。过程中又入坑了洋垃圾，低成本攒了一个12核24线程64G内存的服务器，服务器噪声还是有的，在电源并没有选服务器模组电源的情况下，日常 40dB 左右噪音还可以接收，但这么大个的东西还是只能放书房最合适，书房的网线终于排上了用场，这时拓扑已变为：

![家庭网络 V3.0.png](https://cdn.jsdelivr.net/gh/jervyshi/jervyshi.github.io/assets/images/1627718148061-64716ca5-e239-4d69-bfaa-96ecbd38a344.png)

AC88U 和 AC68U 在这个拓扑下是只做无线 AP 使用同时也组成 Mesh 网络，关闭 DHCP 能力，R2S 做主路由负责拨号、科学上网、端口转发、广告屏蔽、内网穿透（Zerotier）等能力入口。

服务器装了 ESXI 并按照 CentOS 和 Win10 虚拟机，Win10 可以通过内网穿透加 RDP 随意穿回内网，CentOS 装了 Kubernetes 做一个自己的测试机，可玩性极高。

另外再推荐下[八爷](https://twitter.com/waylybaye)的 ServerCat，电信的公网 IP 加上仅密钥登录，手机管理家庭设备，使用频率虽不高，但是胜在能装 X 啊。

![IMG_2789.JPG](https://cdn.jsdelivr.net/gh/jervyshi/jervyshi.github.io/assets/images/1627719424077-6aa61cd3-4dd2-44ab-8791-f55a3cb67c40.jpeg)

缺点是 R2S 做主路由不适合经常折腾，否则刷机之后全家上不了网，分分钟就要面对全家的质问，这个 SLA 保障不好影响家庭和谐。更好的方式是软路由做旁路由，受限于我当前的设备及网线情况，这种折腾方式暂时不适用我的情况。

## 0x05 总结一下

装修比较早，网线埋的超五类，升级困难，再来一次就准备直接拉光纤了，局域网设备极限速度大幅提升，成本也不会增加很多。弱电箱到客厅建议至少拉上三条网线避免想把主路由放客厅的时候不好来回就比较尴尬。有科学上网诉求建议还是上个软路由，可玩性和速度好很多。当然你要是能读到这里大概率也会根据自己的情况构建适合自己的网络拓扑，毕竟我博客没科学上网也访问不了。

折腾无止境，这也只是阶段性的拓扑，接下来说不定也就换旁路由模式来玩。

如果你对洋垃圾感兴趣这里有我的配置单供参考，基础配置来自[账户未命名](https://www.youtube.com/watch?v=UpNTTsoI24Y&list=PL4Bi3PNHpZKxSIyXx3wvy1yqqigxtlS0u)，我做了部分修改：

| 部件 | 型号 | 价格参考 |
| --- | --- | --- |
| CPU | E5 2658AV3 | 399 |
| 散热 | 捷豹超微款E5 2011 CPU散热器【正方形扣具】 | 159 |
| 主板 | 华硕Z10PA-U8/10G-2S | 1300 |
| 内存 | 三星ECC内存 16Gx4 （DDR4 2133） | 1060 |
| 机箱/电源 | 超微 CSE-743TQ-865B-SQ 8盘位塔式服务器机箱EATX主板工作站机箱 + 超微 PWS-865-PQ 865W 塔式工作站电源 | 1100 |
| 硬盘 | 金胜维（KingSpec）M.2 SATA 2242 SSD固态硬盘 1TB SATA协议 2242 NGFF/M.2 | 650 |
| 前面板 | TOOLFREE MRA752 2.5寸+3.5寸SATA光驱位硬盘盒抽取盒+USB3.0 Hub | 180 |

